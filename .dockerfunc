#!/bin/bash
# Bash wrappers for docker run commands

# Helper Functions
function dcleanup(){
	docker rm -v $(docker ps --filter status=exited -q 2>/dev/null) 2>/dev/null
	docker rmi $(docker images --filter dangling=true -q 2>/dev/null) 2>/dev/null
}

function container_start(){
	local container=$1
	docker inspect $container 1>/dev/null 2>&1
	if [ $? -eq 0 ]
	then
		local state=`docker inspect --format "{{.State.Running}}" $container`
		if [ "x$state" == "xtrue" ]
		then
			echo "$container is running, removing..." >&2
			docker stop $container
			docker rm $container
			return 1
		else
			echo "$container is not running, attaching..." >&2
			docker start $container
			docker attach $container
			return 0
		fi
	else
		echo "$container does not exist" >&2
		return 1
	fi
}

function container_remove(){
	local container=$1
	docker inspect $container 1>/dev/null 2>&1
	if [ $? -eq 0 ]
	then
		echo "romving container $container" >&2
		docker rm $container
	else
		echo "$container does not exist" >&2
	fi
}

function relies_on(){
	local containers=$@

	for container in $containers; do
		local state=$(docker inspect --format "{{.State.Running}}" $container 2>/dev/null)

		if [[ "$state" == "false" ]] || [[ "$state" == "" ]]; then
			echo "$container is not running, starting it for you."
			$container
		fi
	done
}

function dm(){
	machine=$1
	container_start $machine
	if [ $? -eq 0 ]
	then
		return 0
	fi

	base=`docker images | grep "$machine" | awk '{print $1}'`
	echo "creating..." >&2
	docker run -it \
		-v $HOME/git:/root/git \
		-v $HOME:/root/home \
		-w /root/git \
		--security-opt seccomp=unconfined \
		--hostname $machine \
		--name $machine \
		$base:$machine \
		/bin/bash

	## http://stackoverflow.com/questions/35860527/warning-error-disabling-address-space-randomization-operation-not-permitted/35860616
}

