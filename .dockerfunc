#!/bin/bash
# Bash wrappers for docker run commands

index="index.tenxcloud.com/ericuni"

# Helper Functions
function dcleanup(){
	sudo docker rm -v $(docker ps --filter status=exited -q 2>/dev/null) 2>/dev/null
	sudo docker rmi $(docker images --filter dangling=true -q 2>/dev/null) 2>/dev/null
}

function container_start(){
	local container=$1
	sudo docker inspect $container 1>/dev/null 2>&1
	if [ $? -eq 0 ]
	then
		local state=`docker inspect --format "{{.State.Running}}" $container`
		if [ "x$state" == "xtrue" ]
		then
			echo "$container is running, removing..." >&2
			sudo docker stop $container
			sudo docker rm $container
			return 1
		else
			echo "$container is not running, attaching..." >&2
			sudo docker start $container
			sudo docker attach $container
			return 0
		fi
	else
		echo "$container does not exist" >&2
		return 1
	fi
}

function container_remove(){
	local container=$1
	sudo docker inspect $container 1>/dev/null 2>&1
	if [ $? -eq 0 ]
	then
		echo "romving container $container" >&2
		sudo docker rm $container
	else
		echo "$container does not exist" >&2
	fi
}

function relies_on(){
	local containers=$@

	for container in $containers; do
		local state=$(docker inspect --format "{{.State.Running}}" $container 2>/dev/null)

		if [[ "$state" == "false" ]] || [[ "$state" == "" ]]; then
			echo "$container is not running, starting it for you."
			$container
		fi
	done
}

# Container Aliases
## terminal env
function dev(){
	container_start dev
	if [ $? -eq 0 ]
	then
		return 0
	fi

	echo "creating..." >&2
	sudo docker run -it \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v /usr/share/fonts:/usr/share/fonts \
		-e DISPLAY=unix$DISPLAY \
		-e LANG=C.UTF-8 \
		-v $HOME:/root \
		-w /root \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--hostname dev \
		--name dev \
		debian:dev

	return 0
}

function debian(){
	container_start debian
	if [ $? -eq 0 ]
	then
		return 0
	fi

	echo "creating..." >&2

	sudo docker run -it \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v /usr/share/fonts:/usr/share/fonts \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-e LANG=C.UTF-8 \
		-v $HOME:/root \
		-w /root \
		--hostname debian \
		--name debian \
		debian:jessie
}

function centos(){
	container_start centos
	if [ $? -eq 0 ]
	then
		return 0
	fi

	echo "creating..." >&2

	sudo docker run -it \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v /usr/share/fonts:/usr/share/fonts \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-e LANG=C.UTF-8 \
		-v $HOME:/root \
		-w /root \
		--hostname centos \
		--name centos \
		centos:7.2
}

function texlive(){
	container_start texlive
	if [ $? -eq 0 ]
	then
		return 0
	fi

	echo "creating..." >&2

	sudo docker run -it \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		-e LANG=C.UTF-8 \
		-v $HOME/git:/root/git \
		-w /root/git \
		--hostname texlive \
		--name texlive \
		debian:texlive
}

## GUI env
function rstudio(){
	local container="rstudio"
	container_remove $container
	if [ $? -ne 0 ]
	then
		echo "remove $container error"
	fi

	echo "starting $container in background" >&2
	sudo docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v /usr/share/fonts:/usr/share/fonts \
		-e DISPLAY=unix$DISPLAY \
		-v $HOME:/root \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--name $container \
		$index/rstudio
}

function wiznote(){
	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v /usr/share/fonts:/usr/share/fonts \
		-e DISPLAY=unix$DISPLAY \
		-v $HOME/.wiznote:/root/.wiznote \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--name wiznote \
		$index/wiznote:latest
}

function wpsoffice(){
	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v /usr/share/fonts:/usr/share/fonts \
		-e DISPLAY=unix$DISPLAY \
		-v $HOME:/root \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--rm \
		--name wps \
		$index/wps:latest
}

function libreoffice(){
	docker run -d \
		-v /etc/localtime:/etc/localtime:ro \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v /usr/share/fonts:/usr/share/fonts \
		-e DISPLAY=unix$DISPLAY \
		-v $HOME:/root \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--name libreoffice \
		ubuntu:libreoffice
}

function tor(){
	docker run -d \
		-v /tmp/.X11-unix:/tmp/.X11-unix \
		-v /dev/snd:/dev/snd \
		-e DISPLAY=unix$DISPLAY \
		-e GDK_SCALE \
		-e GDK_DPI_SCALE \
		--name tor \
		debian:tor-browser
}

